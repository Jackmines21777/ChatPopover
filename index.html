<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <title>Local-ChatPopover</title>

    <script >
        document.addEventListener("DOMContentLoaded", () => {
            const $form = document.querySelector('form')
            $form.addEventListener("submit", (e) => {
                e.preventDefault();
            })
        })
    </script>


    <script type="module">
        document.addEventListener('mouseup', function (e) {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
    
        if (selectedText) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const popover = document.getElementById('popover');
        const popoverText = document.getElementById('popover__text');
        const popoverCopy = document.getElementById('popover__copy');
        const popoverChrome = document.getElementById('popover__chrome');
        const popoverChat = document.getElementById('popover__chat');
        const searchInput = document.getElementById('search-input');
    
        popoverText.textContent = selectedText;
        popover.style.left = `${rect.left + window.scrollX}px`;
        popover.style.top = `${rect.top + window.scrollY - popover.offsetHeight}px`;
        popover.style.display = 'block';
    
        popoverCopy.onclick = function () {
            navigator.clipboard.writeText(selectedText).then(() => {
            alert('Copiado');
            });
        };
    
        popoverChrome.onclick = function () {
            searchInput.value = selectedText;
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(selectedText)}`;
            window.open(searchUrl, '_blank');
            console.log(selectedText, searchUrl);
        };

        popoverChat.onclick = function () {
            searchInput.value = selectedText;
        };


        } else {
        document.getElementById('popover').style.display = 'none';
        }
    });
    </script>


    <!--* El script de tipo modulo me permite hacer que mi script sea cargado de forma diferica -->
    <script type="module">

        // https://github.com/mlc-ai/web-llm?tab=readme-ov-file
        import { CreateMLCEngine, CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";



        const $ = el => document.querySelector(el);

        //* se pone delante de la variable un simbolo de $
        //* para indicar que es un elemento del DOM 
        const $form = $('form')
        const $input = $('input')
        const $template = $('#message_template')
        const $messages = $('ul')
        const $container = $('main')
        const $button = $('button')
        const $info = $('small')
        let messages = [];

        // resource in https://github.com/mlc-ai/web-llm/blob/main/src/config.ts#L581
        const SELECTED_MODEL = 'Llama-3-8B-Instruct-q4f32_1-MLC'


        if(window.Worker) { //Usa para verificar si existe workers 
        const worker = new Worker('./worker.js');
        worker.postMessage("hello worker")
        }


        const engine = await CreateWebWorkerMLCEngine(
            // new Worker('./worker.js'); sol indica que es un archivo js, que no importa nada por ende no es un modulo
            new Worker(
                new URL('./worker.js', import.meta.url),
                {
                    type: "module" // con esto especificaremos que es de tipo modulo(ECMAscript modules) el worker al que hacemos referencia, pues el worker si esta importando `import { WebWorkerMLCEngineHandler } from "https://esm.run/@mlc-ai/web-llm";`
                }
            ),
            SELECTED_MODEL,
            {
                initProgressCallback: (info) => {
                    // muestra la carga del modelo, es decir, que lo descargara en el ordenador del usuario
                    $info.textContent = `${info.text}`
                    if (info.progress === 1) {
                        $button.removeAttribute('disabled')
                    }
                }
            }
        );





        // const engine = await CreateMLCEngine(
        //     SELECTED_MODEL,
        //     {
        //         initProgressCallback: (info) => {
        //             // muestra la carga del modelo, es decir, que lo descargara en el ordenador del usuario
        //             $info.textContent = `${info.text}`
        //             if (info.progress === 1) {
        //                 $button.removeAttribute('disabled')
        //             }
        //         }
        //     }
        // )


        $form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageText = $input.value.trim();
            if (messageText !== '') {
                // añadimos el mensaje en el DON
                $input.value = ''
                addMessage(messageText, 'user')
                $button.setAttribute('disabled', '') // $button.disabled = true

                const userMessage = {
                    role: 'user',
                    content: messageText
                }
                messages.push(userMessage)

                console.log(messages)
                const chunks = await engine.chat.completions.create({
                    messages,
                    stream: true
                })

                let reply = "";
                const $botMessage = addMessage("", 'bot')

                for await (const chunk of chunks) {
                    const choice = chunk.choices[0] //  const [choice] = chunk.choices;
                    const content = choice?.delta?.content ?? "" // ? => optional chaining y ?? nulling operator ||
                    reply += content;
                    $botMessage.textContent = reply;
                    // $botMessage.append(content);
                    // $container.scrollTop = $container.scrollHeight;
                }

                // console.log(reply)
                $button.removeAttribute('disabled')
                const botMessage = reply
                messages.push({
                    role: 'assistant',
                    content: reply
                })
                // addMessage(botMessage.content, 'bot')
            }
        })

        function addMessage(text, sender) {
    // Clonar el template y obtener referencias a los elementos dentro de él
    const clonedTemplate = $template.content.cloneNode(true);
    const $newMessage = clonedTemplate.querySelector('.message');
    const $who = $newMessage.querySelector('span');
    const $text = $newMessage.querySelector('p');

    // Asignar el texto del mensaje y el remitente
    $text.textContent = text;
    $who.innerHTML = sender === 'bot' ? `<i class='bx bx-bot'></i>` : `<i class='bx bx-user'></i>`;

    // Agregar una clase al mensaje según el remitente
    $newMessage.classList.add(sender === 'bot' ? 'bot' : 'user');
    // Agregar el nuevo mensaje al contenedor
    $messages.appendChild($newMessage);

    // Actualizar el scroll para mostrar el nuevo mensaje
    $messages.scrollTop = $messages.scrollHeight;

    return $text; // Retornar el elemento de texto del mensaje (opcional)
}

    </script>
</head>
<body>

    <section>

            <div class="vistaProducto">

                <div class="vistaProducto__title">
                        <p class="title__marca">Apple</p>
                        <p class="title__name"> MacBook Pro 16" Chip M3 Pro, 512GB ssd, 36GB ram, macOs, teclado en inglés, negro</p>
                        <hr class="title__hr">
                </div>

                <div class="vistaProducto__caracteristicas">
                        <div class="caja__caracteristicas caja ">
                            <li><span class="caracteristica__nombre">Tamaño de pantalla: </span><span class="caracteristicas__valor">16"</span></li>
                            <li><span class="caracteristica__nombre">Procesador:</span> <span class="caracteristicas__valor">Chip M3 Pro de Apple</span></li>
                            <li><span class="caracteristica__nombre">Memoria RAM:</span> <span class="caracteristicas__valor">36 GB</p></li>
                            <li><span class="caracteristica__nombre">Capacidad de disco sólido (SSD):</span> <span class="caracteristicas__valor">512 GB</span></li>
                            <li><span class="caracteristica__nombre">Tipo de panel: </span><span class="caracteristicas__valor">IPS</span></li>
                            <li><span class="caracteristica__nombre">Tipo de gráficos:</span> <span class="caracteristicas__valor">Integrado</span></li>
                            <li><span class="caracteristica__nombre">Incluye sistema operativo: </span><span class="caracteristicas__valor">Sí</span></li>
                            <li><span class="caracteristica__nombre">Nombre de SO: </span><span class="caracteristicas__valor">macOS</span></li>
                            <a href="#tablaCaracteristica" class="caracteristicas__verMas">Ver más características</a>
                        </div>

                        <div class="caja__descripcion caja">
                            <li>Sumérgete en la perfección de la MacBook Pro 16", la tecnología que combina elegancia y rendimiento.</li>
                            <li>Impulsada por el potente Chip M3 Pro, su pantalla IPS de 16 pulgadas te envuelve en una experiencia visual excepcional.</li>
                            <li>Equipada con una asombrosa memoria RAM de 36 GB y un SSD de 512 GB, disfrutarás de una velocidad impresionante.</li>
                        </div>
                </div>

                <div class="vistaProducto__image image__gallery">
                    <img class="gallery__img" src="https://i0.wp.com/icenter.pe/wp-content/uploads/2021/05/macbook-pro-16-1.jpg" alt="">
                </div>

                <div class="vistaProducto__preventa">
                        <div class="shoppingCart">
            
                          
                
            
                            <div class="shoppingCart__precio --hr__vertical">
                                <div class="precio__container">
                                    <div class="precio">
                                        <p class="precio__normal">S/. 2500.00</p>
                                        <p class="precio__especial --red">S/. 1200.00</p>
                                    </div>
                                    
                                    
                                    <div class="preventa__cantidad">
                                        <button class="btnIcon menos">-</button>
                                        <input  type="text" class="input" value="1">
                                        <button class="btnIcon mas">+</button>
                                    </div>
                                </div>
            
                                <div class="total">
            
                                    <p class="precio__name">Total:</p>
                                    <p type="number" class="precio__total">S/ 1200.00</p>
                                </div>
                            </div>
            
                           
            
            
                            <div class="shoppingCart__actions">
                                <button class="btn btn--invertir btnAgregar ">Elminar</button>
                                <button class="btn btnComprar">Ver</button>
                            </div>
                        </div>
                    
                </div>
                
            </div>

        <div class="tablaProducto">

            <div class="tablaProducto__header">
                <p class="tablaProducto__title">Acerca del Producto</p>
                <hr>
            </div>

            <div class="tablaProducto__cuerpo">

                <p class="cuerpo__subtitle">Especificaciones Técnicas</p>

                <div id="tablaCaracteristica" class="tablaCaracteristica">

            
                    <table>
                        <tbody>
                            <tr>
                                <td class="nameCaracteristica">Caracteristica</td>
                                <td class="valorCaracteristica">Valor 1</td>
                            </tr>
                            <tr>
                                <td class="nameCaracteristica">Caracteristica</td>
                                <td class="valorCaracteristica" >Valor 2</td>
                            </tr>
                            <tr>
                                <td class="nameCaracteristica" >Caracteristica</td>
                                <td class="valorCaracteristica" >Valor 3</td>
                            </tr>

                        </tbody>
                    </table>
                </div>

            </div>
        </div>

    </section>

<!--  -->
<!--  -->

<!--  -->


    <button id="chat-button" class="chat-button">
        <i class='bx bx-bot'></i>
    </button>

    

        <div id="chat-box" class="chat-box">

            <div class="chat-header">
                <p>Chat de Ayuda</p>
                <button id="close-chat" class="close-chat">&times;</button>
            </div>

            <div class="chat-body">
                <ul>
                    <li class="message bot">
                        <i id="i" class='bx bx-bot'></i>
                        <p>¿Qué deseas saber?</p>
                    </li>

                    <li class="message user">
                        <!-- <span><i class='bx bx-user'></i></span> -->
                        <!-- <p>Esta es la respuesta del usuario y es una respuesta muy larga -->
                                <!-- para ver que no se rompa nada -->
                        <!-- </p> -->
                    </li>
                </ul>
            </div>
            <form>
                <div class="chat-footer">
                    <input id="search-input" type="text" name="message" placeholder="Escribe tu mensaje...">
                    <button type="submit"><i class='bx bx-send'></i></button>
                </div>
            </form>
            <small></small>
        
            <!--* no se renderiza, pero me permite introducir html de manera dinamica con js  -->
            <template id="message_template">
                <li class="message">
                    <span></span>
                    <p></p>
                </li>
            </template>
        </div>






        <div id="popover" class="popover">

            <span id="popover__text"></span>
        
            <button id="popover__copy">
                <i class='bx bx-copy'></i>
            </button>
        
            <button id="popover__chrome">
              <i class='bx bxl-chrome' ></i>
            </button>
        
            <button id="popover__chat">
              <i class='bx bx-bot'></i>
            </button>
        
        </div>

    <script src="index.js"></script>
</body>
</html>